<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Drone RL Visualizer</title>
    <style>
        /* --- Basic Setup & Dark Theme --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- Main Layout Container --- */
        .container {
            text-align: center;
            padding: 20px;
        }

        h1 {
            color: #03dac6;
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* --- Canvas for the Simulation --- */
        canvas {
            background-color: #1e1e1e;
            border: 2px solid #03dac6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(3, 218, 198, 0.2);
        }

        /* --- Stats Panel --- */
        #statsPanel {
            margin-top: 20px;
            background-color: #1e1e1e;
            padding: 15px 25px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid #333;
        }

        #statsPanel p {
            margin: 8px 0;
            font-size: 1.1em;
            text-align: left;
        }

        #statsPanel span {
            color: #bb86fc;
            font-weight: bold;
            min-width: 60px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ESP32 Drone Delivery RL Visualizer</h1>
        <canvas id="simulationCanvas"></canvas>
        <div id="statsPanel">
            <p><strong>Episode:</strong> <span id="episode">--</span></p>
            <p><strong>Epsilon (Explore %):</strong> <span id="epsilon">--</span></p>
        </div>
    </div>

    <script>
        // =================================================================
        // --- CONFIGURATION: PASTE YOUR FIREBASE URL HERE ---
        // =================================================================
        const FIREBASE_DB_URL = "https://openware-ai-default-rtdb.firebaseio.com/ESP32/";

        // =================================================================
        // --- Canvas and Drawing Setup ---
        // =================================================================
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        const WORLD_WIDTH = 400;
        const WORLD_HEIGHT = 300;
        canvas.width = WORLD_WIDTH;
        canvas.height = WORLD_HEIGHT;

        // Global variables to hold the latest data from Firebase
        let simState = {}; 
        let stats = {};

        /**
         * The main drawing loop, runs continuously.
         */
        function draw() {
            // Clear canvas with a dark background
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);

            // Draw Ground
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(0, WORLD_HEIGHT - 2, WORLD_WIDTH, 2);

            if (simState.world) {
                const { buildings, pickup_x, pickup_y, dropoff_x, dropoff_y } = simState.world;

                // Draw Buildings
                ctx.fillStyle = '#616161';
                buildings?.forEach(b => {
                    // Y-coordinate is flipped because canvas (0,0) is top-left
                    ctx.fillRect(b.x, WORLD_HEIGHT - b.h, b.w, b.h);
                });

                // Draw Pickup Target (Circle)
                ctx.fillStyle = simState.drone?.has_package ? 'rgba(3, 218, 198, 0.2)' : '#03dac6';
                ctx.beginPath();
                ctx.arc(pickup_x, WORLD_HEIGHT - pickup_y, 10, 0, 2 * Math.PI);
                ctx.fill();

                // Draw Dropoff Target (Square)
                ctx.strokeStyle = '#bb86fc';
                ctx.lineWidth = 3;
                ctx.strokeRect(dropoff_x - 10, WORLD_HEIGHT - dropoff_y - 10, 22, 22);
            }
            
            // Draw Drone
            if (simState.drone) {
                const { x, y, has_package } = simState.drone;
                const droneY = WORLD_HEIGHT - y; // Flip Y-coordinate

                // Draw Drone Body
                ctx.fillStyle = has_package ? '#bb86fc' : '#03dac6';
                ctx.fillRect(x - 10, droneY - 5, 20, 10);

                // Draw thruster fire based on last action from ESP32
                ctx.fillStyle = '#f39c12';
                switch (simState.last_action) {
                    case 1: ctx.fillRect(x-3, droneY + 5, 6, 8); break; // Thrust Up
                    case 2: ctx.fillRect(x-3, droneY - 13, 6, 8); break; // Thrust Down
                    case 3: ctx.fillRect(x+10, droneY - 3, 8, 6); break; // Thrust Left
                    case 4: ctx.fillRect(x-18, droneY - 3, 8, 6); break; // Thrust Right
                }
            }

            // Request the next frame
            requestAnimationFrame(draw);
        }

        /**
         * Sets up the listeners to Firebase using the REST API's streaming capability.
         */
        function setupFirebaseListeners() {
            if (!FIREBASE_DB_URL || FIREBASE_DB_URL.includes("your-project-name")) {
                alert("Please configure your Firebase Database URL in the script tag!");
                return;
            }

            // Listener for the main simulation state
            const simStateUrl = `${FIREBASE_DB_URL}/simulation_state.json`;
            const simStateEventSource = new EventSource(simStateUrl);

            simStateEventSource.addEventListener('put', (e) => {
                const eventData = JSON.parse(e.data);
                if (eventData.path === "/") {
                     // This is a "reset" event, data contains the full state
                     simState = eventData.data;
                } else {
                    // This is a partial update, merge it into the existing state
                    // Note: Firebase REST 'put' on a sub-path gives the new data for that path.
                    // The ESP32 code is designed to overwrite the whole object, so this is robust.
                    simState = eventData.data;
                }
            });
            
            simStateEventSource.onerror = (e) => {
                console.error("Simulation state stream error:", e);
            };

            // Listener for the training statistics
            const statsUrl = `${FIREBASE_DB_URL}/training_stats.json`;
            const statsEventSource = new EventSource(statsUrl);

            statsEventSource.addEventListener('put', (e) => {
                const eventData = JSON.parse(e.data);
                stats = eventData.data;
                document.getElementById('episode').textContent = stats.episode || '--';
                document.getElementById('epsilon').textContent = stats.epsilon ? parseFloat(stats.epsilon).toFixed(4) : '--';
            });
            
            statsEventSource.onerror = (e) => {
                console.error("Stats stream error:", e);
            };
            
            console.log("Firebase listeners attached via REST API.");
        }

        // --- Start Everything ---
        setupFirebaseListeners();
        requestAnimationFrame(draw);

    </script>
</body>
</html>
