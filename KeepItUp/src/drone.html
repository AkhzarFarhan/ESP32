<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Drone RL Visualizer</title>
    <style>
        /* --- Basic Setup & Dark Theme --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- Main Layout Container --- */
        .container {
            text-align: center;
            padding: 20px;
        }

        h1 {
            color: #03dac6;
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* --- Canvas for the Simulation --- */
        canvas {
            background-color: #1e1e1e;
            border: 2px solid #03dac6;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(3, 218, 198, 0.2);
        }

        /* --- Stats Panel --- */
        #statsPanel {
            margin-top: 20px;
            background-color: #1e1e1e;
            padding: 15px 25px;
            border-radius: 8px;
            display: inline-block;
            border: 1px solid #333;
        }

        #statsPanel p {
            margin: 8px 0;
            font-size: 1.1em;
            text-align: left;
        }

        #statsPanel span {
            color: #bb86fc;
            font-weight: bold;
            min-width: 60px;
            display: inline-block;
        }

        #droneStatus {
            margin-top: 10px;
            font-size: 0.9em;
            color: #03dac6;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ESP32 Drone Delivery RL Visualizer</h1>
        <canvas id="simulationCanvas"></canvas>
        <div id="statsPanel">
            <p><strong>Episode:</strong> <span id="episode">--</span></p>
            <p><strong>Epsilon (Explore %):</strong> <span id="epsilon">--</span></p>
            <div id="droneStatus">
                <p><strong>Position:</strong> <span id="dronePos">--</span></p>
                <p><strong>Package Status:</strong> <span id="packageStatus">--</span></p>
                <p><strong>Last Action:</strong> <span id="lastAction">--</span></p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // --- CONFIGURATION: PASTE YOUR FIREBASE URL HERE ---
        // =================================================================
        const FIREBASE_DB_URL = "https://openware-ai-default-rtdb.firebaseio.com/ESP32/";

        // =================================================================
        // --- Canvas and Drawing Setup ---
        // =================================================================
        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        const WORLD_WIDTH = 400;
        const WORLD_HEIGHT = 300;
        canvas.width = WORLD_WIDTH;
        canvas.height = WORLD_HEIGHT;

        // Global variables to hold the latest data from Firebase
        let simState = {}; 
        let stats = {};

        /**
         * The main drawing loop, runs continuously.
         */
        function draw() {
            // Clear canvas with a dark background
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);

            // Draw Ground
            ctx.fillStyle = '#4a4a4a';
            ctx.fillRect(0, WORLD_HEIGHT - 2, WORLD_WIDTH, 2);

            // Check if we have any simulation data
            if (simState && typeof simState === 'object') {
                // For debugging - log the structure we received
                console.log("Current simState:", simState);

                // Draw drone if position data is available
                if (simState.x !== undefined && simState.y !== undefined) {
                    const droneY = WORLD_HEIGHT - simState.y; // Flip Y-coordinate

                    // Draw Drone Body
                    ctx.fillStyle = simState.has_package ? '#bb86fc' : '#03dac6';
                    ctx.fillRect(simState.x - 10, droneY - 5, 20, 10);

                    // Draw thruster fire based on last action from ESP32
                    if (simState.last_action !== undefined) {
                        ctx.fillStyle = '#f39c12';
                        switch (simState.last_action) {
                            case 1: ctx.fillRect(simState.x-3, droneY + 5, 6, 8); break; // Thrust Up
                            case 2: ctx.fillRect(simState.x-3, droneY - 13, 6, 8); break; // Thrust Down
                            case 3: ctx.fillRect(simState.x+10, droneY - 3, 8, 6); break; // Thrust Left
                            case 4: ctx.fillRect(simState.x-18, droneY - 3, 8, 6); break; // Thrust Right
                        }
                    }
                }

                // Draw targets if available
                if (simState.target_x !== undefined && simState.target_y !== undefined) {
                    // Draw current target (changes based on has_package state)
                    if (simState.has_package) {
                        // Draw Dropoff Target (Square) - drone has package, going to dropoff
                        ctx.strokeStyle = '#bb86fc';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(simState.target_x - 10, WORLD_HEIGHT - simState.target_y - 10, 20, 20);
                        
                        // Add label
                        ctx.fillStyle = '#bb86fc';
                        ctx.font = '12px sans-serif';
                        ctx.fillText('DROPOFF', simState.target_x - 25, WORLD_HEIGHT - simState.target_y + 35);
                    } else {
                        // Draw Pickup Target (Circle) - drone needs to pickup package
                        ctx.fillStyle = '#03dac6';
                        ctx.beginPath();
                        ctx.arc(simState.target_x, WORLD_HEIGHT - simState.target_y, 10, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Add label
                        ctx.fillStyle = '#03dac6';
                        ctx.font = '12px sans-serif';
                        ctx.fillText('PICKUP', simState.target_x - 20, WORLD_HEIGHT - simState.target_y + 25);
                    }
                }

                // Draw battery indicator
                if (simState.battery !== undefined) {
                    const batteryWidth = 100;
                    const batteryHeight = 8;
                    const batteryX = 10;
                    const batteryY = 10;
                    const batteryLevel = Math.max(0, Math.min(1, simState.battery / 600)); // Assuming max battery is 600
                    
                    // Battery outline
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(batteryX, batteryY, batteryWidth, batteryHeight);
                    
                    // Battery fill
                    ctx.fillStyle = batteryLevel > 0.3 ? '#4caf50' : batteryLevel > 0.1 ? '#ff9800' : '#f44336';
                    ctx.fillRect(batteryX + 1, batteryY + 1, (batteryWidth - 2) * batteryLevel, batteryHeight - 2);
                    
                    // Battery text
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '10px sans-serif';
                    ctx.fillText(`Battery: ${Math.round(simState.battery)}`, batteryX, batteryY + batteryHeight + 15);
                }

                // Draw velocity indicator
                if (simState.vx !== undefined && simState.vy !== undefined) {
                    ctx.fillStyle = '#e0e0e0';
                    ctx.font = '10px sans-serif';
                    ctx.fillText(`Velocity: (${simState.vx.toFixed(2)}, ${simState.vy.toFixed(2)})`, 10, 45);
                }
            } else {
                // Show message when no data is available
                ctx.fillStyle = '#ff5722';
                ctx.font = '16px sans-serif';
                ctx.fillText('Waiting for drone data...', 50, WORLD_HEIGHT / 2);
            }

            // Request the next frame
            requestAnimationFrame(draw);
        }

        /**
         * Sets up the listeners to Firebase using the REST API's streaming capability.
         */
        function setupFirebaseListeners() {
            if (!FIREBASE_DB_URL || FIREBASE_DB_URL.includes("your-project-name")) {
                alert("Please configure your Firebase Database URL in the script tag!");
                return;
            }

            // Listener for the main simulation state
            const simStateUrl = `${FIREBASE_DB_URL}/simulation_state.json`;
            const simStateEventSource = new EventSource(simStateUrl);

            simStateEventSource.addEventListener('put', (e) => {
                const eventData = JSON.parse(e.data);
                console.log("Firebase simulation_state event:", eventData);
                
                if (eventData.path === "/") {
                     // This is a "reset" event, data contains the full state
                     simState = eventData.data || {};
                } else {
                    // This is a partial update, merge it into the existing state
                    // Note: Firebase REST 'put' on a sub-path gives the new data for that path.
                    // The ESP32 code is designed to overwrite the whole object, so this is robust.
                    simState = eventData.data || {};
                }
                console.log("Updated simState:", simState);
                updateDroneStatus();
            });
            
            simStateEventSource.addEventListener('patch', (e) => {
                const eventData = JSON.parse(e.data);
                console.log("Firebase simulation_state patch:", eventData);
                
                // Merge patch data into existing state
                if (eventData.data && typeof eventData.data === 'object') {
                    simState = { ...simState, ...eventData.data };
                }
                console.log("Patched simState:", simState);
                updateDroneStatus();
            });
            
            simStateEventSource.onerror = (e) => {
                console.error("Simulation state stream error:", e);
            };

            // Listener for the training statistics
            const statsUrl = `${FIREBASE_DB_URL}/training_stats.json`;
            const statsEventSource = new EventSource(statsUrl);

            statsEventSource.addEventListener('put', (e) => {
                const eventData = JSON.parse(e.data);
                console.log("Firebase training_stats event:", eventData);
                
                stats = eventData.data || {};
                document.getElementById('episode').textContent = stats.episode || '--';
                document.getElementById('epsilon').textContent = stats.epsilon ? parseFloat(stats.epsilon).toFixed(4) : '--';
            });
            
            statsEventSource.addEventListener('patch', (e) => {
                const eventData = JSON.parse(e.data);
                console.log("Firebase training_stats patch:", eventData);
                
                if (eventData.data && typeof eventData.data === 'object') {
                    stats = { ...stats, ...eventData.data };
                    document.getElementById('episode').textContent = stats.episode || '--';
                    document.getElementById('epsilon').textContent = stats.epsilon ? parseFloat(stats.epsilon).toFixed(4) : '--';
                }
            });
            
            statsEventSource.onerror = (e) => {
                console.error("Stats stream error:", e);
            };
            
            console.log("Firebase listeners attached via REST API.");
        }

        /**
         * Updates the drone status display in the stats panel
         */
        function updateDroneStatus() {
            if (simState && typeof simState === 'object') {
                // Update position
                if (simState.x !== undefined && simState.y !== undefined) {
                    document.getElementById('dronePos').textContent = `(${Math.round(simState.x)}, ${Math.round(simState.y)})`;
                }
                
                // Update package status
                document.getElementById('packageStatus').textContent = simState.has_package ? 'Has Package' : 'No Package';
                
                // Update last action
                const actionNames = ['None', 'Thrust Up', 'Thrust Down', 'Thrust Left', 'Thrust Right'];
                if (simState.last_action !== undefined && simState.last_action >= 0 && simState.last_action < actionNames.length) {
                    document.getElementById('lastAction').textContent = actionNames[simState.last_action];
                } else {
                    document.getElementById('lastAction').textContent = '--';
                }
            }
        }

        // --- Start Everything ---
        setupFirebaseListeners();
        requestAnimationFrame(draw);

    </script>
</body>
</html>
