<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIDAR Distance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8892b0;
            font-size: 1rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Current Reading - Large Display */
        .current-reading {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .current-value {
            font-size: 5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-unit {
            font-size: 2rem;
            color: #8892b0;
        }

        .current-cm {
            font-size: 1.5rem;
            color: #8892b0;
            margin-top: 10px;
        }

        /* Stats Sections */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-title .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-1s {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
        }

        .badge-10s {
            background: linear-gradient(135deg, #7b2cbf, #9b59b6);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-label {
            color: #8892b0;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-value.avg { color: #00d4ff; }
        .stat-value.min { color: #2ed573; }
        .stat-value.max { color: #ff6b6b; }

        .stat-unit {
            font-size: 0.9rem;
            color: #8892b0;
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: scale(1.05);
        }

        #distanceChart {
            max-height: 350px;
        }

        /* History Section */
        .history-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-avg { color: #00d4ff; font-weight: 600; }
        .history-min { color: #2ed573; }
        .history-max { color: #ff6b6b; }
        .history-time { color: #8892b0; text-align: right; }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8892b0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .current-value { font-size: 3rem; }
            .stats-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .history-item { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 480px) {
            .status-bar { flex-direction: column; align-items: center; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¥ LIDAR Distance Monitor</h1>
            <p class="subtitle">Real-time VL53L0X Sensor Data from ESP32</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionStatus">Connecting...</span>
            </div>
            <div class="status-item">
                <span>üì° Last Update:</span>
                <span id="lastUpdate">--</span>
            </div>
            <div class="status-item">
                <span>üîÑ Readings:</span>
                <span id="readingsCount">0</span>
            </div>
        </div>

        <!-- Current Reading - Big Display -->
        <div class="current-reading">
            <div>
                <span class="current-value" id="currentDistance">--</span>
                <span class="current-unit">mm</span>
            </div>
            <div class="current-cm" id="currentDistanceCm">-- cm</div>
        </div>

        <!-- 1-Second and 10-Second Stats -->
        <div class="stats-row">
            <!-- 1-Second Stats -->
            <div class="stats-section">
                <div class="stats-title">
                    <span class="badge badge-1s">1 SEC</span>
                    <span>Recent Second Statistics</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Average</div>
                        <div class="stat-value avg" id="avg1s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Minimum</div>
                        <div class="stat-value min" id="min1s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Maximum</div>
                        <div class="stat-value max" id="max1s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                </div>
            </div>

            <!-- 10-Second Stats -->
            <div class="stats-section">
                <div class="stats-title">
                    <span class="badge badge-10s">10 SEC</span>
                    <span>10-Second Period Statistics</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Average</div>
                        <div class="stat-value avg" id="avg10s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Minimum</div>
                        <div class="stat-value min" id="min10s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Maximum</div>
                        <div class="stat-value max" id="max10s">--</div>
                        <div class="stat-unit">mm</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üìâ Live Distance Graph (Avg, Min, Max)</h2>
                <div class="chart-controls">
                    <button class="btn btn-secondary" onclick="clearChart()">Clear</button>
                    <button class="btn btn-primary" onclick="togglePause()">
                        <span id="pauseBtn">‚è∏ Pause</span>
                    </button>
                </div>
            </div>
            <canvas id="distanceChart"></canvas>
        </div>

        <!-- History Section -->
        <div class="history-section">
            <div class="history-header">
                <h2 class="chart-title">üìú 10-Second Batch History</h2>
                <button class="btn btn-secondary" onclick="clearHistory()">Clear</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Waiting for data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase REST API URL
        const FIREBASE_URL = 'https://openware-ai-default-rtdb.firebaseio.com/ESP32/LIDAR';
        
        // Chart configuration
        const MAX_DATA_POINTS = 60;
        let avgData = [];
        let minData = [];
        let maxData = [];
        let timeLabels = [];
        let isPaused = false;
        let readingsCount = 0;
        let lastTimestamp = null;
        let historyItems = [];

        // Initialize Chart.js with Avg, Min, Max lines
        const ctx = document.getElementById('distanceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [
                    {
                        label: 'Average (mm)',
                        data: avgData,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 3
                    },
                    {
                        label: 'Minimum (mm)',
                        data: minData,
                        borderColor: '#2ed573',
                        backgroundColor: 'rgba(46, 213, 115, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 2,
                        borderDash: [5, 5]
                    },
                    {
                        label: 'Maximum (mm)',
                        data: maxData,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 2,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 300
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: { color: '#8892b0' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#00d4ff',
                        bodyColor: '#fff',
                        borderColor: '#00d4ff',
                        borderWidth: 1,
                        cornerRadius: 10,
                        padding: 12
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#8892b0', maxTicksLimit: 10 }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#8892b0' },
                        min: 0,
                        suggestedMax: 2000
                    }
                }
            }
        });

        // Fetch data from Firebase
        async function fetchLatestData() {
            try {
                const response = await fetch(`${FIREBASE_URL}/latest.json`);
                const data = await response.json();
                
                if (data && data.timestamp !== undefined) {
                    // Only update if new data
                    if (data.timestamp !== lastTimestamp) {
                        updateUI(data);
                        lastTimestamp = data.timestamp;
                        readingsCount++;
                    }
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus(false);
            }
        }

        // Update UI with new data
        function updateUI(data) {
            // Current distance
            const distance = data.distance_mm || 0;
            document.getElementById('currentDistance').textContent = distance;
            document.getElementById('currentDistanceCm').textContent = (distance / 10).toFixed(1) + ' cm';
            
            // 1-Second stats
            if (data.one_second) {
                document.getElementById('avg1s').textContent = data.one_second.avg_mm || '--';
                document.getElementById('min1s').textContent = data.one_second.min_mm || '--';
                document.getElementById('max1s').textContent = data.one_second.max_mm || '--';
            }
            
            // 10-Second stats
            if (data.ten_second) {
                document.getElementById('avg10s').textContent = data.ten_second.avg_mm || '--';
                document.getElementById('min10s').textContent = data.ten_second.min_mm || '--';
                document.getElementById('max10s').textContent = data.ten_second.max_mm || '--';
            }
            
            // Update readings count
            document.getElementById('readingsCount').textContent = readingsCount;
            
            // Update chart if not paused
            if (!isPaused && data.one_second) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString();
                
                timeLabels.push(timeStr);
                avgData.push(data.one_second.avg_mm);
                minData.push(data.one_second.min_mm);
                maxData.push(data.one_second.max_mm);
                
                // Keep only last MAX_DATA_POINTS
                if (timeLabels.length > MAX_DATA_POINTS) {
                    timeLabels.shift();
                    avgData.shift();
                    minData.shift();
                    maxData.shift();
                }
                
                chart.update('none');
            }
            
            // Add to history (10-second batches)
            if (data.ten_second) {
                addToHistory(data.ten_second);
            }
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                dot.classList.add('connected');
                status.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                status.textContent = 'Disconnected';
            }
        }

        // Add 10-second batch to history
        function addToHistory(tenSecData) {
            const historyList = document.getElementById('historyList');
            const now = new Date();
            
            // Create unique key based on data
            const key = `${tenSecData.avg_mm}-${tenSecData.min_mm}-${tenSecData.max_mm}`;
            
            // Don't add duplicate entries
            if (historyItems.length > 0 && historyItems[0].key === key) {
                return;
            }
            
            // Remove loading message if present
            if (historyItems.length === 0) {
                historyList.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <span class="history-avg">Avg: ${tenSecData.avg_mm} mm</span>
                <span class="history-min">Min: ${tenSecData.min_mm} mm</span>
                <span class="history-max">Max: ${tenSecData.max_mm} mm</span>
                <span class="history-time">${now.toLocaleTimeString()}</span>
            `;
            
            historyList.insertBefore(item, historyList.firstChild);
            historyItems.unshift({ key, time: now });
            
            // Keep only last 30 items
            if (historyItems.length > 30) {
                historyItems.pop();
                historyList.removeChild(historyList.lastChild);
            }
        }

        // Clear chart data
        function clearChart() {
            timeLabels.length = 0;
            avgData.length = 0;
            minData.length = 0;
            maxData.length = 0;
            chart.update();
        }

        // Clear history
        function clearHistory() {
            historyItems = [];
            document.getElementById('historyList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Waiting for data...</p>
                </div>
            `;
        }

        // Toggle pause
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        }

        // Start fetching data every second
        setInterval(fetchLatestData, 1000);
        fetchLatestData(); // Initial fetch
    </script>
</body>
</html>
