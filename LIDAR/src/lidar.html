<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIDAR Distance Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8892b0;
            font-size: 1rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .card-icon.primary { background: linear-gradient(135deg, #00d4ff, #0099ff); }
        .card-icon.success { background: linear-gradient(135deg, #2ed573, #17a854); }
        .card-icon.warning { background: linear-gradient(135deg, #ffa502, #ff7f00); }
        .card-icon.purple { background: linear-gradient(135deg, #7b2cbf, #9b59b6); }

        .card-label {
            color: #8892b0;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .card-unit {
            font-size: 1rem;
            color: #8892b0;
            margin-left: 5px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: #fff;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:hover {
            transform: scale(1.05);
        }

        #distanceChart {
            max-height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            color: #8892b0;
        }

        .stat-value {
            font-weight: 600;
            color: #00d4ff;
        }

        .history-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: background 0.3s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-distance {
            font-weight: 600;
            color: #00d4ff;
        }

        .history-time {
            color: #8892b0;
            font-size: 0.85rem;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8892b0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .card-value { font-size: 2rem; }
            .cards { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 480px) {
            .cards { grid-template-columns: 1fr; }
            .status-bar { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¥ LIDAR Distance Monitor</h1>
            <p class="subtitle">Real-time VL53L0X Sensor Data from ESP32</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionStatus">Connecting...</span>
            </div>
            <div class="status-item">
                <span>üì° Firebase</span>
                <span id="lastUpdate">--</span>
            </div>
            <div class="status-item">
                <span>üîÑ Refresh Rate</span>
                <span>1s</span>
            </div>
        </div>

        <div class="cards">
            <div class="card">
                <div class="card-icon primary">üìè</div>
                <div class="card-label">Current Distance</div>
                <div>
                    <span class="card-value" id="currentDistance">--</span>
                    <span class="card-unit">mm</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon success">üìê</div>
                <div class="card-label">Distance (cm)</div>
                <div>
                    <span class="card-value" id="currentDistanceCm">--</span>
                    <span class="card-unit">cm</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon warning">üìä</div>
                <div class="card-label">Average (Session)</div>
                <div>
                    <span class="card-value" id="avgDistance">--</span>
                    <span class="card-unit">mm</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon purple">üìà</div>
                <div class="card-label">Readings Count</div>
                <div>
                    <span class="card-value" id="readingsCount">0</span>
                    <span class="card-unit">total</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üìâ Live Distance Graph</h2>
                <div class="chart-controls">
                    <button class="btn btn-secondary" onclick="clearChart()">Clear</button>
                    <button class="btn btn-primary" onclick="togglePause()">
                        <span id="pauseBtn">‚è∏ Pause</span>
                    </button>
                </div>
            </div>
            <canvas id="distanceChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title" style="margin-bottom: 20px;">üìä Session Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Minimum</span>
                    <span class="stat-value" id="minDistance">-- mm</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Maximum</span>
                    <span class="stat-value" id="maxDistance">-- mm</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Range</span>
                    <span class="stat-value" id="rangeDistance">-- mm</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Change</span>
                    <span class="stat-value" id="lastChange">-- mm</span>
                </div>
            </div>
        </div>

        <div class="history-section">
            <div class="history-header">
                <h2 class="chart-title">üìú Recent Readings</h2>
                <button class="btn btn-secondary" onclick="clearHistory()">Clear History</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Waiting for data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase REST API URL
        const FIREBASE_URL = 'https://openware-ai-default-rtdb.firebaseio.com/ESP32/LIDAR';
        
        // Chart configuration
        const MAX_DATA_POINTS = 60;
        let distanceData = [];
        let timeLabels = [];
        let isPaused = false;
        let readingsCount = 0;
        let allReadings = [];
        let lastDistance = null;
        let historyItems = [];

        // Initialize Chart.js
        const ctx = document.getElementById('distanceChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Distance (mm)',
                    data: distanceData,
                    borderColor: '#00d4ff',
                    backgroundColor: 'rgba(0, 212, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: '#00d4ff',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 300
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#00d4ff',
                        bodyColor: '#fff',
                        borderColor: '#00d4ff',
                        borderWidth: 1,
                        cornerRadius: 10,
                        padding: 12
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#8892b0',
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#8892b0'
                        },
                        min: 0,
                        suggestedMax: 2000
                    }
                }
            }
        });

        // Fetch data from Firebase
        async function fetchLatestData() {
            try {
                const response = await fetch(`${FIREBASE_URL}/latest.json`);
                const data = await response.json();
                
                if (data && data.distance_mm !== undefined) {
                    updateUI(data);
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus(false);
            }
        }

        // Update UI with new data
        function updateUI(data) {
            const distance = data.distance_mm;
            const distanceCm = data.distance_cm || (distance / 10).toFixed(1);
            
            // Update cards
            document.getElementById('currentDistance').textContent = distance;
            document.getElementById('currentDistanceCm').textContent = parseFloat(distanceCm).toFixed(1);
            
            // Track readings
            if (lastDistance !== distance) {
                readingsCount++;
                allReadings.push(distance);
                
                // Calculate change
                if (lastDistance !== null) {
                    const change = distance - lastDistance;
                    const changeSign = change >= 0 ? '+' : '';
                    document.getElementById('lastChange').textContent = `${changeSign}${change} mm`;
                }
                
                lastDistance = distance;
                
                // Update chart if not paused
                if (!isPaused) {
                    const now = new Date();
                    const timeStr = now.toLocaleTimeString();
                    
                    timeLabels.push(timeStr);
                    distanceData.push(distance);
                    
                    // Keep only last MAX_DATA_POINTS
                    if (timeLabels.length > MAX_DATA_POINTS) {
                        timeLabels.shift();
                        distanceData.shift();
                    }
                    
                    chart.update('none');
                }
                
                // Add to history
                addToHistory(distance);
            }
            
            // Update statistics
            document.getElementById('readingsCount').textContent = readingsCount;
            
            if (allReadings.length > 0) {
                const avg = Math.round(allReadings.reduce((a, b) => a + b, 0) / allReadings.length);
                const min = Math.min(...allReadings);
                const max = Math.max(...allReadings);
                
                document.getElementById('avgDistance').textContent = avg;
                document.getElementById('minDistance').textContent = `${min} mm`;
                document.getElementById('maxDistance').textContent = `${max} mm`;
                document.getElementById('rangeDistance').textContent = `${max - min} mm`;
            }
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                dot.classList.add('connected');
                status.textContent = 'Connected';
            } else {
                dot.classList.remove('connected');
                status.textContent = 'Disconnected';
            }
        }

        // Add reading to history list
        function addToHistory(distance) {
            const historyList = document.getElementById('historyList');
            const now = new Date();
            
            // Remove loading message if present
            if (historyItems.length === 0) {
                historyList.innerHTML = '';
            }
            
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `
                <span class="history-distance">${distance} mm (${(distance/10).toFixed(1)} cm)</span>
                <span class="history-time">${now.toLocaleTimeString()}</span>
            `;
            
            historyList.insertBefore(item, historyList.firstChild);
            historyItems.unshift({ distance, time: now });
            
            // Keep only last 50 items
            if (historyItems.length > 50) {
                historyItems.pop();
                historyList.removeChild(historyList.lastChild);
            }
        }

        // Clear chart data
        function clearChart() {
            timeLabels.length = 0;
            distanceData.length = 0;
            chart.update();
        }

        // Clear history
        function clearHistory() {
            historyItems = [];
            document.getElementById('historyList').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Waiting for data...</p>
                </div>
            `;
        }

        // Toggle pause
        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        }

        // Start fetching data
        setInterval(fetchLatestData, 1000);
        fetchLatestData(); // Initial fetch
    </script>
</body>
</html>
